<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>儿童易失踪空间风险感知研究平台</title>
    
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-blue: #0066cc;
            --primary-blue-dark: #0052a3;
            --text-primary: #000;
            --text-secondary: #666;
            --text-muted: #999;
            --bg-white: #ffffff;
            --bg-light: #fafafa;
            --border-color: #e0e0e0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: var(--bg-white);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* ==================== 页面容器 ==================== */
        .page {
            display: none;
            min-height: 100vh;
            padding: 3rem 2rem;
            position: relative;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative; /* 为绝对定位子元素提供参照 */
        }
        
        /* ==================== 欢迎页 ==================== */
        #page-welcome .page-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6rem;
            align-items: center;
            min-height: calc(100vh - 6rem);
            padding-bottom: 0.5rem; /* 为底部署名留出空间 */
        }
        
        .hero-left .page-number {
            font-size: 8rem;
            font-weight: 900;
            color: var(--primary-blue);
            line-height: 0.9;
            margin-bottom: 2rem;
            letter-spacing: -0.05em;
        }
        
        .hero-left h1 {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 2rem;
            letter-spacing: -0.04em;
        }
        
        .hero-left .subtitle {
            font-size: 1.125rem;
            line-height: 1.7;
            color: var(--text-secondary);
            margin-bottom: 3rem;
        }
        
        /* 团队署名新样式 */
        .team-branding {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
            font-weight: 500;
            width: 100%;
        }
        
        /* 团队署名上方的短装饰条 */
        .team-branding::before {
            content: '';
            display: block;
            width: 40px; /* 长度变短 */
            height: 3px;
            background: var(--primary-blue);
            margin: 0 auto 1rem auto; /* 居中 */
            border-radius: 2px;
        }
        
        .hero-right {
            padding-left: 4rem;
            border-left: 1px solid var(--border-color);
        }
        
        .info-section {
            margin-bottom: 3rem;
        }
        
        .info-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .info-section p {
            font-size: 1.125rem;
            color: var(--text-primary);
            line-height: 1.7;
        }
        
        .stats-row {
            display: flex;
            gap: 3rem;
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 1px solid var(--border-color);
        }
        
        .stat-item .stat-number {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary-blue);
            line-height: 1;
        }
        
        .stat-item .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .consent-box {
            margin-top: 3rem;
            padding: 2rem;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-wrapper label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .checkbox-wrapper label a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
        }
        
        .checkbox-wrapper label a:hover {
            text-decoration: underline;
        }
        
        .btn {
            display: inline-block;
            padding: 1.25rem 3rem;
            background: var(--primary-blue);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2rem;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--primary-blue-dark);
            transform: translateX(8px);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* ==================== 信息填写页 ==================== */
        #page-info .page-container {
            max-width: 800px;
        }
        
        .page-header {
            margin-bottom: 4rem;
        }
        
        .page-header h1 {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 1rem;
            letter-spacing: -0.03em;
        }
        
        .page-header .subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        #dependent-fields {
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 2rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        
        .form-label .required {
            color: var(--primary-blue);
            margin-left: 4px;
        }
        
        .form-control {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            background: var(--bg-white);
            transition: all 0.2s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .form-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 2rem 0 2rem 0;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        
        .form-section-desc {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        
        /* ==================== 实验说明页 ==================== */
        #page-instruction .content-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 4rem;
        }
        
        .main-content {
            padding-right: 2rem;
        }
        
        .main-content h2 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 2rem;
            letter-spacing: -0.03em;
        }
        
        .main-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 3rem 0 1.5rem 0;
            color: var(--text-primary);
        }
        
        .main-content p {
            font-size: 1.125rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        .main-content ul {
            margin: 1.5rem 0;
            padding-left: 1.5rem;
        }
        
        .main-content li {
            font-size: 1.125rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .main-content li strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .sidebar-sticky {
            position: sticky;
            top: 2rem;
            background: var(--bg-light);
            padding: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .sidebar-sticky h4 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        
        .sidebar-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-item:last-child {
            border-bottom: none;
        }
        
        .sidebar-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .sidebar-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* ==================== 图片比较页 ==================== */
        #page-comparison .page-container {
            max-width: 1400px;
        }
        
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .progress-info {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }
        
        .progress-number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-blue);
            margin-left: 1rem;
        }
        
        .prompt-text {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }
        
        .image-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .image-box {
            cursor: pointer;
            border: 3px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            aspect-ratio: 8/3; 
            background: var(--bg-light);
        }
        
        .image-box::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }
        
        .image-box::after {
            content: '点击选择此环境';
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2;
        }
        
        .image-box:hover:not(.disabled) {
            border-color: var(--primary-blue);
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(0, 102, 204, 0.2);
        }
        
        .image-box:hover:not(.disabled)::before,
        .image-box:hover:not(.disabled)::after {
            opacity: 1;
        }
        
        .image-box.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* ==================== 反馈页 ==================== */
        #page-feedback .page-container {
            max-width: 800px;
            text-align: center;
        }
        
        .feedback-header {
            margin-bottom: 4rem;
        }
        
        .feedback-header .checkmark {
            width: 80px;
            height: 80px;
            background: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin: 0 auto 2rem;
        }
        
        .feedback-header h1 {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 1rem;
        }
        
        .feedback-form {
            text-align: left;
            margin-bottom: 3rem;
        }
        
        .feedback-form textarea {
            width: 100%;
            padding: 1.5rem;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            resize: vertical;
            min-height: 150px;
            font-family: inherit;
        }
        
        .feedback-form textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        .char-count {
            text-align: right;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 3rem;
        }
        
        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-white);
            border-color: var(--text-primary);
        }
        
        /* ==================== 感谢页 ==================== */
        #page-thanks .page-container {
            max-width: 800px;
            text-align: center;
            padding: 6rem 2rem;
        }
        
        #page-thanks h1 {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 2rem;
            letter-spacing: -0.04em;
        }
        
        #page-thanks .subtitle {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 4rem;
        }
        
        .thanks-content {
            text-align: left;
            margin-bottom: 4rem;
        }
        
        .thanks-section {
            margin-bottom: 3rem;
            padding: 2rem;
            background: var(--bg-light);
            border-left: 4px solid var(--primary-blue);
        }
        
        .thanks-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .thanks-section p {
            font-size: 1.125rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .contact-info {
            margin-top: 4rem;
            padding-top: 3rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.95rem;
            color: var(--text-muted);
        }
        
        .contact-info a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
        }
        
        /* ==================== 模态框 ==================== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 3rem;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 40px;
            height: 40px;
            background: var(--bg-light);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content h2 {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 2rem;
        }
        
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 2rem 0 1rem 0;
        }
        
        .modal-content p {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        /* ==================== 加载动画 ==================== */
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        #loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ==================== 响应式 ==================== */
        @media (max-width: 1024px) {
            #page-welcome .page-container,
            #page-instruction .content-wrapper,
            .form-grid,
            .image-container,
            .button-group {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .hero-right {
                border-left: none;
                border-top: 1px solid var(--border-color);
                padding-left: 0;
                padding-top: 3rem;
            }
            
            .team-branding {
                position: relative; /* 移动端取消绝对定位，改为流式布局 */
                bottom: auto;
                left: auto;
                transform: none;
                margin-top: 3rem;
            }
            
            .hero-left .page-number {
                font-size: 5rem;
            }
            
            .hero-left h1 {
                font-size: 2.5rem;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding-right: 0;
            }
            
            .sidebar-sticky {
                position: static;
            }
            
            .image-box {
                aspect-ratio: 8/3;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div id="privacy-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePrivacyModal()">×</button>
            <h2>研究参与协议与隐私政策</h2>
            
            <h3>研究目的</h3>
            <p>本研究旨在评估不同街道环境中儿童"易失踪"的空间风险感知,为改善城市公共空间安全提供依据。</p>
            
            <h3>参与内容</h3>
            <p>您将被要求完成约30组街道环境图片的比较,选择您认为更易使儿童失踪的环境。整个过程大约需要5-15分钟。</p>
            
            <h3>隐私保护</h3>
            <p>我们收集的所有信息仅用于学术研究目的,不会收集您的姓名、精确位置等个人身份信息。所有数据将以去标识化方式存储和分析。</p>
            
            <h3>自愿参与</h3>
            <p>您的参与完全自愿,可以随时退出研究而不会有任何负面影响。</p>
            
            <h3>数据使用</h3>
            <p>收集的数据将用于学术研究和发表,但不会涉及个人身份信息。研究结果将以聚合形式呈现。</p>
            
            <h3>联系方式</h3>
            <p>如有任何疑问,请联系研究团队:<br>西北大学人地关系与空间安全特色优势科研团队<br>邮箱: libingcheng3979@163.com</p>
        </div>
    </div>

    <div id="page-welcome" class="page active">
        <div class="page-container">
            <div class="hero-left">
                <div class="page-number">Urban Perception</div>
                <h1>让城市对孩子<br>更安全</h1>
                <p class="subtitle">基于公众感知的街道空间低龄儿童易失踪风险评估</p>
            </div>
            
            <div class="hero-right">
                <div class="info-section">
                    <h3>平台简介</h3>
                    <p>儿童失踪事件的每一次发生都会给家庭和社会带来巨大痛苦。我们希望通过收集公众对街道环境感知的真实判断，识别城市中潜在的“易失踪”高风险空间，为守护儿童安全、优化城市环境提供科学依据。您的每一次选择，都是守护未来的力量。</p>
                </div>
                
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number">5-15</div>
                        <div class="stat-label">分钟</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">30</div>
                        <div class="stat-label">组图片</div>
                    </div>
                </div>
                
                <div class="consent-box">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="consent-checkbox">
                        <label for="consent-checkbox">
                            我已阅读并同意<a href="#" onclick="openPrivacyModal(); return false;">研究参与协议与隐私政策</a> <span style="color: #0066cc;">*</span>
                        </label>
                    </div>
                </div>
                
                <button id="btn-agree" class="btn btn-block" disabled>开始参与 →</button>
            </div>

            <div class="team-branding">西北大学人地关系与空间安全特色优势科研团队</div>
        </div>
    </div>

    <div id="page-info" class="page">
        <div class="page-container">
            <div class="page-header">
                <h1>基本信息</h1>
                <p class="subtitle">请填写以下信息以帮助我们更好地分析数据</p>
            </div>
            
            <form id="form-participant">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">性别 <span class="required">*</span></label>
                        <select class="form-control" id="gender" required>
                            <option value="">请选择</option>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">年龄段 <span class="required">*</span></label>
                        <select class="form-control" id="age_group" required>
                            <option value="">请选择</option>
                            <option value="18-25岁">18-25岁</option>
                            <option value="26-35岁">26-35岁</option>
                            <option value="36-45岁">36-45岁</option>
                            <option value="46岁以上">46岁以上</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">是否有低龄儿童(0-6岁)陪护经验 <span class="required">*</span></label>
                        <select class="form-control" id="child_care_experience" required>
                            <option value="">请选择</option>
                            <option value="true">是</option>
                            <option value="false">否</option>
                        </select>
                    </div>
                </div>

                <div id="dependent-fields">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">陪护经验年限 <span class="required">*</span></label>
                            <select class="form-control" id="care_years">
                                <option value="">请选择</option>
                                <option value="<1年">少于1年</option>
                                <option value="1-3年">1-3年</option>
                                <option value="3-5年">3-5年</option>
                                <option value=">5年">5年以上</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">与陪护儿童的关系 <span class="required">*</span></label>
                            <select class="form-control" id="relation_with_child">
                                <option value="">请选择</option>
                                <option value="父母">父母</option>
                                <option value="祖父母">祖父母</option>
                                <option value="老师">老师</option>
                                <option value="保姆">保姆</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <h2 class="form-section-title">选填信息</h2>
                <p class="form-section-desc">以下信息为可选项,填写有助于我们更好地分析数据</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">教育水平</label>
                        <select class="form-control" id="education_level">
                            <option value="">请选择</option>
                            <option value="高中及以下">高中及以下</option>
                            <option value="大专/本科">大专/本科</option>
                            <option value="硕士">硕士</option>
                            <option value="博士及以上">博士及以上</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">是否常驻西安</label>
                        <select class="form-control" id="residence_area">
                            <option value="">请选择</option>
                            <option value="是">是</option>
                            <option value="否">否</option>
                        </select>
                    </div>
                </div>
            </form>
            
            <button id="btn-submit-info" class="btn btn-block">继续 →</button>
        </div>
    </div>

    <div id="page-instruction" class="page">
        <div class="page-container">
            <div class="page-header">
                <h1>评价任务说明</h1>
            </div>
            
            <div class="content-wrapper">
                <div class="main-content">
                    <h3>任务概述</h3>
                    <p>平台将展示30组街道环境的全景图片对比较,请根据您的经验和直觉,判断哪个环境更容易使低龄儿童(0-6岁)失踪。整个过程大概需要5-15分钟完成。</p>
                    
                    <h3>判断时可考虑的因素</h3>
                    <ul>
                        <li><strong>视线开阔度:</strong> 街道的可视范围和监护者能否快速发现儿童</li>
                        <li><strong>人员流动:</strong> 人流密度和复杂程度</li>
                        <li><strong>空间复杂性:</strong> 街道结构的复杂性和可识别性</li>
                        <li><strong>环境吸引力:</strong> 对儿童的吸引程度</li>
                        <li><strong>潜在危险:</strong> 车流、障碍物等安全隐患</li>
                        <li><strong>其他因素:</strong> 您认为重要的任何因素</li>
                    </ul>
                    
                    <h3>重要提示</h3>
                    <p>图片的比较没有标准答案,请根据您的真实感受做出判断,无需过度分析每个细节。请相信您的第一直觉。</p>
                </div>
                
                <div class="sidebar-sticky">
                    <h4>快速指南</h4>
                    
                    <div class="sidebar-item">
                        <div class="sidebar-label">评价数量</div>
                        <div class="sidebar-value">30组图片对</div>
                    </div>
                    
                    <div class="sidebar-item">
                        <div class="sidebar-label">预计时长</div>
                        <div class="sidebar-value">5-15分钟</div>
                    </div>
                    
                    <div class="sidebar-item">
                        <div class="sidebar-label">操作方式</div>
                        <div class="sidebar-value">点击图片选择</div>
                    </div>
                    
                    <div class="sidebar-item">
                        <div class="sidebar-label">最短停留</div>
                        <div class="sidebar-value">每组1秒</div>
                    </div>
                    
                    <button id="btn-start-experiment" class="btn btn-block">开始评价</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-comparison" class="page">
        <div class="page-container">
            <div class="comparison-header">
                <div>
                    <span class="progress-info">Progress</span>
                    <span class="progress-number"><span id="current-index">1</span> / <span id="total-count">30</span></span>
                </div>
            </div>
            
            <div class="prompt-text">
                请判断哪个街道环境更容易使低龄儿童(0-6岁)失踪?
            </div>
            
            <div class="image-container">
                <div class="image-box" id="left-image" data-choice="left">
                    <img id="img-left" src="" alt="街道环境A">
                </div>
                <div class="image-box" id="right-image" data-choice="right">
                    <img id="img-right" src="" alt="街道环境B">
                </div>
            </div>
        </div>
    </div>

    <div id="page-feedback" class="page">
        <div class="page-container">
            <div class="feedback-header">
                <div class="checkmark">✓</div>
                <h1>本轮评价完成</h1>
                <p class="subtitle">感谢您的参与</p>
            </div>
            
            <div class="feedback-form">
                <label class="form-label">体验反馈 (选填,最多50字)</label>
                <textarea id="feedback-text" maxlength="50" placeholder="您可以分享使用体验、建议或遇到的问题..."></textarea>
                <div class="char-count"><span id="char-count">0</span> / 50</div>
            </div>
            
            <div class="button-group">
                <button id="btn-continue" class="btn">继续评价</button>
                <button id="btn-finish" class="btn btn-secondary">结束实验</button>
            </div>
        </div>
    </div>

    <div id="page-thanks" class="page">
        <div class="page-container">
            <h1>实验完成</h1>
            <p class="subtitle">感谢您对城市安全研究的贡献</p>
            
            <div class="thanks-content">
                <div class="thanks-section">
                    <h3>数据价值</h3>
                    <p>您提交的感知数据将帮助我们识别高风险街道空间特征,训练深度学习模型,为城市规划和儿童保护政策提供科学依据。</p>
                </div>
                
                <div class="thanks-section">
                    <h3>研究应用</h3>
                    <p>研究成果将用于学术发表和城市安全改善建议,所有数据以聚合形式呈现,不会涉及个人信息。</p>
                </div>
            </div>
            
            <div class="contact-info">
                <p>西北大学人地关系与空间安全特色优势科研团队</p>
                <p>联系邮箱: <a href="mailto:libingcheng3979@163.com">libingcheng3979@163.com</a></p>
                <p style="margin-top: 2rem; opacity: 0.6;">© 2025 本平台数据受隐私保护,仅用于学术研究</p>
            </div>
        </div>
    </div>

    <script>
        // LeanCloud配置
        const LEANCLOUD_CONFIG = {
            appId: 'uzZcqNVUEsS5NHf82r0QJRdR-gzGzoHsz',
            appKey: 'VavvdrQPWVEjweyMAYgOSNat',
            serverURL: 'https://uzzcqnvu.lc-cn-n1-shared.com'
        };
        
        AV.init(LEANCLOUD_CONFIG);
        
        // 全局状态
        const appState = {
            participantId: localStorage.getItem('participant_id') || null,
            roundId: null,
            currentTasks: [],
            currentTaskIndex: 0,
            startTime: null,
            isSubmitting: false,
            preloadedImages: {}
        };
        
        // 工具函数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let deviceType = 'Desktop';
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                deviceType = 'Tablet';
            } else if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                deviceType = 'Mobile';
            }
            return { type: deviceType, userAgent: ua };
        }
        
        // [修改] 已删除 getIPAddress 函数，由后端获取
        
        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('active', show);
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
        }
        
        function preloadImage(url) {
            return new Promise((resolve, reject) => {
                if (appState.preloadedImages[url]) {
                    resolve(url);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    appState.preloadedImages[url] = true;
                    resolve(url);
                };
                img.onerror = () => reject(new Error(`图片加载失败: ${url}`));
                img.src = url;
            });
        }
        
        // 模态框
        function openPrivacyModal() {
            document.getElementById('privacy-modal').classList.add('active');
        }
        
        function closePrivacyModal() {
            document.getElementById('privacy-modal').classList.remove('active');
        }
        
        // 页面1: 欢迎页
        document.getElementById('consent-checkbox').addEventListener('change', function() {
            document.getElementById('btn-agree').disabled = !this.checked;
        });
        
        document.getElementById('btn-agree').addEventListener('click', function() {
            showPage('page-info');
        });
        
        // 页面2: 信息填写
        document.getElementById('child_care_experience').addEventListener('change', function() {
            const isYes = this.value === 'true';
            const dependentSection = document.getElementById('dependent-fields');
            const careYears = document.getElementById('care_years');
            const relation = document.getElementById('relation_with_child');
            
            // 显示/隐藏区域
            dependentSection.style.display = isYes ? 'block' : 'none';
            
            // 切换必填属性
            if (isYes) {
                careYears.setAttribute('required', '');
                relation.setAttribute('required', '');
            } else {
                careYears.removeAttribute('required');
                relation.removeAttribute('required');
                // 清空值
                careYears.value = '';
                relation.value = '';
            }
        });

        document.getElementById('btn-submit-info').addEventListener('click', async function() {
            const form = document.getElementById('form-participant');
            
            if (!form.checkValidity()) {
                alert('请填写所有必填项');
                form.reportValidity();
                return;
            }

            const careExperience = document.getElementById('child_care_experience').value === 'true';

            const formData = {
                gender: document.getElementById('gender').value,
                age_group: document.getElementById('age_group').value,
                child_care_experience: careExperience,
                // 无论是否有经验，都发送这两个字段。无经验时发送 null。
                care_years: careExperience ? document.getElementById('care_years').value : null,
                relation_with_child: careExperience ? document.getElementById('relation_with_child').value : null,
                // 选填信息
                education_level: document.getElementById('education_level').value || null,
                residence_area: document.getElementById('residence_area').value || null
                // 注意：ip_address 字段已从此处移除，交由云函数后端自动获取
            };
            
            const deviceInfo = getDeviceInfo();
            formData.device_type = deviceInfo.type;
            formData.user_agent = deviceInfo.userAgent;
            
            toggleLoading(true);
            
            try {
                // 直接调用云函数，无需等待获取IP
                const result = await AV.Cloud.run('createParticipant', formData);
                if (result.success) {
                    appState.participantId = result.participant_id;
                    localStorage.setItem('participant_id', result.participant_id);
                    showPage('page-instruction');
                } else {
                    alert('提交失败:' + result.error);
                }
            } catch (error) {
                console.error('提交失败:', error);
                alert('网络错误,请检查连接后重试');
            } finally {
                toggleLoading(false);
            }
        });
        
        // 页面3: 实验说明
        document.getElementById('btn-start-experiment').addEventListener('click', async function() {
            await loadNewRound();
        });
        
        // 页面4: 图片比较
        async function loadNewRound() {
            toggleLoading(true);
            try {
                appState.roundId = generateUUID();
                const result = await AV.Cloud.run('getPairTasks', { count: 30 });
                if (result.success && result.tasks.length > 0) {
                    appState.currentTasks = result.tasks;
                    appState.currentTaskIndex = 0;
                    showPage('page-comparison');
                    await showNextPair();
                } else {
                    alert('所有评价任务已完成,感谢参与!');
                    showPage('page-thanks');
                }
            } catch (error) {
                console.error('加载任务失败:', error);
                alert('加载任务失败,请检查网络');
            } finally {
                toggleLoading(false);
            }
        }
        
        async function showNextPair() {
            if (appState.currentTaskIndex >= appState.currentTasks.length) {
                showPage('page-feedback');
                return;
            }
            
            const task = appState.currentTasks[appState.currentTaskIndex];
            document.getElementById('current-index').textContent = appState.currentTaskIndex + 1;
            document.getElementById('total-count').textContent = appState.currentTasks.length;
            
            const randomPosition = Math.random() < 0.5;
            const leftUrl = randomPosition ? task.left_image_url : task.right_image_url;
            const rightUrl = randomPosition ? task.right_image_url : task.left_image_url;
            const leftPid = randomPosition ? task.left_image_pid : task.right_image_pid;
            const rightPid = randomPosition ? task.right_image_pid : task.left_image_pid;
            
            appState.currentTask = {
                pair_id: task.pair_id,
                left_image_pid: leftPid,
                right_image_pid: rightPid
            };
            
            const leftBox = document.getElementById('left-image');
            const rightBox = document.getElementById('right-image');
            leftBox.classList.add('disabled');
            rightBox.classList.add('disabled');
            
            try {
                toggleLoading(true);
                await Promise.all([preloadImage(leftUrl), preloadImage(rightUrl)]);
                document.getElementById('img-left').src = leftUrl;
                document.getElementById('img-right').src = rightUrl;
                
                if (appState.currentTaskIndex + 1 < appState.currentTasks.length) {
                    const nextTask = appState.currentTasks[appState.currentTaskIndex + 1];
                    preloadImage(nextTask.left_image_url);
                    preloadImage(nextTask.right_image_url);
                }
                
                appState.startTime = Date.now();
                setTimeout(() => {
                    leftBox.classList.remove('disabled');
                    rightBox.classList.remove('disabled');
                }, 1000);
            } catch (error) {
                console.error('图片加载失败:', error);
                alert('图片加载失败,请检查网络');
            } finally {
                toggleLoading(false);
            }
        }
        
        async function handleImageChoice(choice) {
            if (appState.isSubmitting) return;
            
            const responseTime = Date.now() - appState.startTime;
            if (responseTime < 1000) {
                alert('请仔细观察图片后再选择(至少停留1秒)');
                return;
            }
            
            appState.isSubmitting = true;
            document.getElementById('left-image').classList.add('disabled');
            document.getElementById('right-image').classList.add('disabled');
            
            const chosenPid = choice === 'left' ? appState.currentTask.left_image_pid : appState.currentTask.right_image_pid;
            
            const voteData = {
                round_id: appState.roundId,
                participant_id: appState.participantId,
                pair_id: appState.currentTask.pair_id,
                pair_index: appState.currentTaskIndex,
                left_image_pid: appState.currentTask.left_image_pid,
                right_image_pid: appState.currentTask.right_image_pid,
                user_choice: choice,
                chosen_image_pid: chosenPid,
                response_time_ms: responseTime,
                choice_timestamp: new Date().toISOString(),
                abnormal_flag: false
            };
            
            try {
                const result = await AV.Cloud.run('submitVote', voteData);
                if (result.success) {
                    appState.currentTaskIndex++;
                    await showNextPair();
                } else {
                    alert('提交失败:' + result.error);
                }
            } catch (error) {
                console.error('提交失败:', error);
                alert('网络错误,请重试');
            } finally {
                appState.isSubmitting = false;
            }
        }
        
        document.getElementById('left-image').addEventListener('click', function() {
            if (!this.classList.contains('disabled')) handleImageChoice('left');
        });
        
        document.getElementById('right-image').addEventListener('click', function() {
            if (!this.classList.contains('disabled')) handleImageChoice('right');
        });
        
        // 页面5: 反馈页
        document.getElementById('feedback-text').addEventListener('input', function() {
            document.getElementById('char-count').textContent = this.value.length;
        });
        
        document.getElementById('btn-continue').addEventListener('click', async function() {
            const feedback = document.getElementById('feedback-text').value.trim();
            if (feedback) await submitFeedback(feedback);
            document.getElementById('feedback-text').value = '';
            document.getElementById('char-count').textContent = '0';
            await loadNewRound();
        });
        
        document.getElementById('btn-finish').addEventListener('click', async function() {
            const feedback = document.getElementById('feedback-text').value.trim();
            if (feedback) {
                toggleLoading(true);
                await submitFeedback(feedback);
                toggleLoading(false);
            }
            showPage('page-thanks');
        });
        
        async function submitFeedback(feedback) {
            if (!feedback) return;
            try {
                await AV.Cloud.run('submitFeedback', {
                    participant_id: appState.participantId,
                    user_feedback: feedback
                });
            } catch (error) {
                console.error('提交反馈失败:', error);
            }
        }
        
        // 初始化
        window.addEventListener('beforeunload', function(e) {
            if (appState.currentTaskIndex > 0 && appState.currentTaskIndex < appState.currentTasks.length) {
                e.preventDefault();
                e.returnValue = '您当前的进度将会丢失,确定要离开吗?';
            }
        });
    </script>
</body>
</html>